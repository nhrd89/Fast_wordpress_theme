name: Deploy PinLightning

on:
  push:
    branches:
      - main
      - claude/setup-pinlightning-theme-5lwUG

env:
  TEST_URL: https://cheerfultalks.com/wanderweave2/capture-the-aesthetic-15-beautiful-mountain-landscapes-for-photography/

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      - name: Install dependencies
        run: npm install

      - name: Build assets
        run: npm run build

      - name: Install sshpass
        run: sudo apt-get update -qq && sudo apt-get install -y -qq sshpass

      - name: Deploy via rsync
        run: |
          sshpass -p '${{ secrets.SFTP_PASS }}' rsync -avz --delete \
            -e "ssh -o StrictHostKeyChecking=no -p ${{ secrets.SFTP_PORT }}" \
            --exclude='.git/' \
            --exclude='node_modules/' \
            --exclude='.env' \
            --exclude='.env.example' \
            --exclude='deploy.sh' \
            --exclude='wp-check.sh' \
            --exclude='package.json' \
            --exclude='package-lock.json' \
            --exclude='.github/' \
            --exclude='*.md' \
            --exclude='.gitignore' \
            ./ ${{ secrets.SFTP_USER }}@${{ secrets.SFTP_HOST }}:${{ secrets.SFTP_REMOTE_PATH }}/

      - name: Flush cache
        run: |
          curl -s -X POST \
            "${{ secrets.SITE_URL }}/wp-json/pinlightning/v1/flush-cache" \
            -H "X-Cache-Secret: ${{ secrets.CACHE_SECRET }}"

      - name: PageSpeed test — Mobile
        id: psi_mobile
        continue-on-error: true
        run: |
          echo "Testing mobile: $TEST_URL"
          RESPONSE=$(curl -s "https://www.googleapis.com/pagespeedonline/v5/runPagespeed?url=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$TEST_URL', safe=''))")&strategy=mobile&key=${{ secrets.PAGESPEED_API_KEY }}")

          # Extract score
          SCORE=$(echo "$RESPONSE" | python3 -c "
          import sys, json
          try:
              d = json.load(sys.stdin)
              if 'lighthouseResult' not in d:
                  print('ERROR: No lighthouseResult in response')
                  if 'error' in d:
                      print(f'API error: {d[\"error\"].get(\"message\", d[\"error\"])}')
                  sys.exit(1)
              print(int(d['lighthouseResult']['categories']['performance']['score']*100))
          except (json.JSONDecodeError, KeyError, TypeError) as e:
              print(f'ERROR: Failed to parse response — {e}')
              sys.exit(1)
          ")
          echo "Mobile Performance Score: $SCORE"
          echo "mobile_score=$SCORE" >> "$GITHUB_OUTPUT"

          # Extract metrics
          echo "$RESPONSE" | python3 -c "
          import sys, json
          try:
              d = json.load(sys.stdin)
              a = d['lighthouseResult']['audits']
              print(f\"  FCP: {a['first-contentful-paint']['displayValue']}\")
              print(f\"  LCP: {a['largest-contentful-paint']['displayValue']}\")
              print(f\"  Speed Index: {a['speed-index']['displayValue']}\")
              print(f\"  TBT: {a['total-blocking-time']['displayValue']}\")
              print(f\"  CLS: {a['cumulative-layout-shift']['displayValue']}\")
          except (json.JSONDecodeError, KeyError, TypeError) as e:
              print(f'Failed to extract metrics: {e}')
          "

          # Extract screenshot
          echo "$RESPONSE" | python3 -c "
          import sys, json, base64
          try:
              d = json.load(sys.stdin)
              ss = d['lighthouseResult']['audits']['final-screenshot']['details']['data']
              if ',' in ss:
                  ss = ss.split(',', 1)[1]
              img = base64.b64decode(ss)
              with open('screenshot-mobile.png', 'wb') as f:
                  f.write(img)
              print(f'Saved screenshot-mobile.png ({len(img):,} bytes)')
          except (json.JSONDecodeError, KeyError, TypeError) as e:
              print(f'Failed to extract screenshot: {e}')
          "

      - name: Wait before desktop test
        run: sleep 10

      - name: PageSpeed test — Desktop
        id: psi_desktop
        continue-on-error: true
        run: |
          echo "Testing desktop: $TEST_URL"
          RESPONSE=$(curl -s "https://www.googleapis.com/pagespeedonline/v5/runPagespeed?url=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$TEST_URL', safe=''))")&strategy=desktop&key=${{ secrets.PAGESPEED_API_KEY }}")

          # Extract score
          SCORE=$(echo "$RESPONSE" | python3 -c "
          import sys, json
          try:
              d = json.load(sys.stdin)
              if 'lighthouseResult' not in d:
                  print('ERROR: No lighthouseResult in response')
                  if 'error' in d:
                      print(f'API error: {d[\"error\"].get(\"message\", d[\"error\"])}')
                  sys.exit(1)
              print(int(d['lighthouseResult']['categories']['performance']['score']*100))
          except (json.JSONDecodeError, KeyError, TypeError) as e:
              print(f'ERROR: Failed to parse response — {e}')
              sys.exit(1)
          ")
          echo "Desktop Performance Score: $SCORE"
          echo "desktop_score=$SCORE" >> "$GITHUB_OUTPUT"

          # Extract metrics
          echo "$RESPONSE" | python3 -c "
          import sys, json
          try:
              d = json.load(sys.stdin)
              a = d['lighthouseResult']['audits']
              print(f\"  FCP: {a['first-contentful-paint']['displayValue']}\")
              print(f\"  LCP: {a['largest-contentful-paint']['displayValue']}\")
              print(f\"  Speed Index: {a['speed-index']['displayValue']}\")
              print(f\"  TBT: {a['total-blocking-time']['displayValue']}\")
              print(f\"  CLS: {a['cumulative-layout-shift']['displayValue']}\")
          except (json.JSONDecodeError, KeyError, TypeError) as e:
              print(f'Failed to extract metrics: {e}')
          "

          # Extract screenshot
          echo "$RESPONSE" | python3 -c "
          import sys, json, base64
          try:
              d = json.load(sys.stdin)
              ss = d['lighthouseResult']['audits']['final-screenshot']['details']['data']
              if ',' in ss:
                  ss = ss.split(',', 1)[1]
              img = base64.b64decode(ss)
              with open('screenshot-desktop.png', 'wb') as f:
                  f.write(img)
              print(f'Saved screenshot-desktop.png ({len(img):,} bytes)')
          except (json.JSONDecodeError, KeyError, TypeError) as e:
              print(f'Failed to extract screenshot: {e}')
          "

      - name: Print score summary
        continue-on-error: true
        run: |
          echo "═══════════════════════════════════"
          echo " Mobile Score:  ${{ steps.psi_mobile.outputs.mobile_score || 'N/A' }}/100"
          echo " Desktop Score: ${{ steps.psi_desktop.outputs.desktop_score || 'N/A' }}/100"
          echo "═══════════════════════════════════"

      - name: Get active plugins
        continue-on-error: true
        run: |
          curl -s -u "${{ secrets.WP_USER }}:${{ secrets.WP_APP_PASSWORD }}" \
            "${{ secrets.SITE_URL }}/wp-json/wp/v2/plugins" \
            | python3 -c "
          import sys, json
          try:
              plugins = json.load(sys.stdin)
              if not isinstance(plugins, list):
                  print(f'Unexpected response: {str(plugins)[:200]}')
                  sys.exit(1)
              with open('active-plugins.txt', 'w') as f:
                  f.write('Active Plugins\n')
                  f.write('=' * 40 + '\n\n')
                  for p in plugins:
                      status = p.get('status', 'unknown')
                      name = p.get('name', 'Unknown')
                      version = p.get('version', '?')
                      f.write(f'[{status:>8}] {name} v{version}\n')
                  f.write(f'\nTotal: {len(plugins)} plugins\n')
              print(open('active-plugins.txt').read())
          except (json.JSONDecodeError, KeyError, TypeError) as e:
              print(f'Failed to parse plugins response: {e}')
          "

      - name: Upload screenshots and plugin list
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deploy-report-${{ github.sha }}
          path: |
            screenshot-mobile.png
            screenshot-desktop.png
            active-plugins.txt
          if-no-files-found: ignore
          retention-days: 30
