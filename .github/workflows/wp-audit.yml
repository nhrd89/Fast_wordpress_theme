name: WP Site Audit

on:
  workflow_dispatch:
    inputs:
      url:
        description: 'URL to test'
        required: false
        default: 'https://cheerfultalks.com/wanderweave2/capture-the-aesthetic-15-beautiful-mountain-landscapes-for-photography/'

jobs:
  audit:
    runs-on: ubuntu-latest

    steps:
      - name: Set test URL
        id: config
        run: |
          URL="${{ github.event.inputs.url }}"
          echo "test_url=$URL" >> "$GITHUB_OUTPUT"
          echo "Testing URL: $URL"
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

      - name: PageSpeed test — Mobile
        id: psi_mobile
        run: |
          URL="${{ steps.config.outputs.test_url }}"
          ENCODED_URL=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$URL', safe=''))")
          echo "Running mobile Lighthouse audit..."

          RESPONSE=$(curl -s "https://www.googleapis.com/pagespeedonline/v5/runPagespeed?url=${ENCODED_URL}&strategy=mobile&key=${{ secrets.PAGESPEED_API_KEY }}")

          # Extract score
          SCORE=$(echo "$RESPONSE" | python3 -c "import sys,json; d=json.load(sys.stdin); print(int(d['lighthouseResult']['categories']['performance']['score']*100))")
          echo "Mobile Performance Score: $SCORE"
          echo "score=$SCORE" >> "$GITHUB_OUTPUT"

          # Extract all metrics and save
          echo "$RESPONSE" | python3 -c "
          import sys, json
          d = json.load(sys.stdin)
          a = d['lighthouseResult']['audits']
          metrics = {
              'FCP': a['first-contentful-paint']['displayValue'],
              'LCP': a['largest-contentful-paint']['displayValue'],
              'Speed Index': a['speed-index']['displayValue'],
              'TBT': a['total-blocking-time']['displayValue'],
              'CLS': a['cumulative-layout-shift']['displayValue'],
          }
          with open('mobile-metrics.txt', 'w') as f:
              for k, v in metrics.items():
                  f.write(f'{k}: {v}\n')
                  print(f'  {k}: {v}')
          "

          # Extract screenshot
          echo "$RESPONSE" | python3 -c "
          import sys, json, base64
          d = json.load(sys.stdin)
          ss = d['lighthouseResult']['audits']['final-screenshot']['details']['data']
          if ',' in ss:
              ss = ss.split(',', 1)[1]
          img = base64.b64decode(ss)
          with open('screenshot-mobile.png', 'wb') as f:
              f.write(img)
          print(f'Saved screenshot-mobile.png ({len(img):,} bytes)')
          "

          # Extract opportunities
          echo "$RESPONSE" | python3 -c "
          import sys, json
          d = json.load(sys.stdin)
          a = d['lighthouseResult']['audits']
          opps = [(k, v) for k, v in a.items()
                  if v.get('details', {}).get('type') == 'opportunity'
                  and v.get('details', {}).get('overallSavingsMs', 0) > 0]
          with open('mobile-opportunities.txt', 'w') as f:
              for key, opp in sorted(opps, key=lambda x: -x[1]['details']['overallSavingsMs']):
                  savings = opp['details']['overallSavingsMs']
                  title = opp.get('title', key)
                  f.write(f'- {title} (save ~{int(savings)}ms)\n')
                  print(f'  - {title} (save ~{int(savings)}ms)')
          " || true

      - name: PageSpeed test — Desktop
        id: psi_desktop
        run: |
          URL="${{ steps.config.outputs.test_url }}"
          ENCODED_URL=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$URL', safe=''))")
          echo "Running desktop Lighthouse audit..."

          RESPONSE=$(curl -s "https://www.googleapis.com/pagespeedonline/v5/runPagespeed?url=${ENCODED_URL}&strategy=desktop&key=${{ secrets.PAGESPEED_API_KEY }}")

          # Extract score
          SCORE=$(echo "$RESPONSE" | python3 -c "import sys,json; d=json.load(sys.stdin); print(int(d['lighthouseResult']['categories']['performance']['score']*100))")
          echo "Desktop Performance Score: $SCORE"
          echo "score=$SCORE" >> "$GITHUB_OUTPUT"

          # Extract all metrics and save
          echo "$RESPONSE" | python3 -c "
          import sys, json
          d = json.load(sys.stdin)
          a = d['lighthouseResult']['audits']
          metrics = {
              'FCP': a['first-contentful-paint']['displayValue'],
              'LCP': a['largest-contentful-paint']['displayValue'],
              'Speed Index': a['speed-index']['displayValue'],
              'TBT': a['total-blocking-time']['displayValue'],
              'CLS': a['cumulative-layout-shift']['displayValue'],
          }
          with open('desktop-metrics.txt', 'w') as f:
              for k, v in metrics.items():
                  f.write(f'{k}: {v}\n')
                  print(f'  {k}: {v}')
          "

          # Extract screenshot
          echo "$RESPONSE" | python3 -c "
          import sys, json, base64
          d = json.load(sys.stdin)
          ss = d['lighthouseResult']['audits']['final-screenshot']['details']['data']
          if ',' in ss:
              ss = ss.split(',', 1)[1]
          img = base64.b64decode(ss)
          with open('screenshot-desktop.png', 'wb') as f:
              f.write(img)
          print(f'Saved screenshot-desktop.png ({len(img):,} bytes)')
          "

          # Extract opportunities
          echo "$RESPONSE" | python3 -c "
          import sys, json
          d = json.load(sys.stdin)
          a = d['lighthouseResult']['audits']
          opps = [(k, v) for k, v in a.items()
                  if v.get('details', {}).get('type') == 'opportunity'
                  and v.get('details', {}).get('overallSavingsMs', 0) > 0]
          with open('desktop-opportunities.txt', 'w') as f:
              for key, opp in sorted(opps, key=lambda x: -x[1]['details']['overallSavingsMs']):
                  savings = opp['details']['overallSavingsMs']
                  title = opp.get('title', key)
                  f.write(f'- {title} (save ~{int(savings)}ms)\n')
                  print(f'  - {title} (save ~{int(savings)}ms)')
          " || true

      - name: Get active plugins
        run: |
          curl -s -u "${{ secrets.WP_USER }}:${{ secrets.WP_APP_PASSWORD }}" \
            "${{ secrets.SITE_URL }}/wp-json/wp/v2/plugins" \
            | python3 -c "
          import sys, json
          plugins = json.load(sys.stdin)
          with open('active-plugins.txt', 'w') as f:
              for p in plugins:
                  status = p.get('status', 'unknown')
                  name = p.get('name', 'Unknown')
                  version = p.get('version', '?')
                  f.write(f'[{status:>8}] {name} v{version}\n')
              f.write(f'\nTotal: {len(plugins)} plugins\n')
          print(open('active-plugins.txt').read())
          "

      - name: Generate audit report
        run: |
          URL="${{ steps.config.outputs.test_url }}"
          MOBILE_SCORE="${{ steps.psi_mobile.outputs.score }}"
          DESKTOP_SCORE="${{ steps.psi_desktop.outputs.score }}"
          TIMESTAMP="$(date -u '+%Y-%m-%d %H:%M:%S UTC')"

          cat > wp-audit-report.txt << REPORT
          ════════════════════════════════════════════
           PinLightning WP Site Audit Report
          ════════════════════════════════════════════

          Timestamp: ${TIMESTAMP}
          URL Tested: ${URL}

          ── Performance Scores ──
          Mobile:  ${MOBILE_SCORE}/100
          Desktop: ${DESKTOP_SCORE}/100

          ── Mobile Metrics ──
          $(cat mobile-metrics.txt 2>/dev/null || echo "N/A")

          ── Desktop Metrics ──
          $(cat desktop-metrics.txt 2>/dev/null || echo "N/A")

          ── Mobile Opportunities ──
          $(cat mobile-opportunities.txt 2>/dev/null || echo "None identified")

          ── Desktop Opportunities ──
          $(cat desktop-opportunities.txt 2>/dev/null || echo "None identified")

          ── Active Plugins ──
          $(cat active-plugins.txt 2>/dev/null || echo "Could not retrieve")

          ════════════════════════════════════════════
           Report generated by WP Site Audit workflow
          ════════════════════════════════════════════
          REPORT

          echo "── Audit Report ──"
          cat wp-audit-report.txt

      - name: Upload audit artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wp-audit-${{ github.run_number }}
          path: |
            wp-audit-report.txt
            screenshot-mobile.png
            screenshot-desktop.png
            active-plugins.txt
          retention-days: 90
